<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=yes">
    <meta charset="UTF-8">
    <title>Fleet Manager tools</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script type="text/javascript"
            src="https://maps.google.com/maps/api/js?key=AIzaSyAFMw8EIo85__hc6c8DjBGyydxicquxLcc&libraries=drawing"></script>
    <style type="text/css">
        #map, html, body {
            padding: 0;
            margin: 0;
            height: 100%;
        }

        #panel {
            width: 200px;
            font-family: Arial, sans-serif;
            font-size: 13px;
            float: right;
            margin: 10px;
        }

        #color-palette {
            clear: both;
        }

        .color-button {
            width: 14px;
            height: 14px;
            font-size: 0;
            margin: 2px;
            float: left;
            cursor: pointer;
        }

        #delete-button {
            margin-top: 5px;
        }

        #show-all-vehicles {
            margin-top: 5px;
        }
    </style>
    <script type="text/javascript">

        var drawingManager;
        var selectedShape;
        var colors = ['#010515', '#09a7ff'];
        var selectedColor;
        var coordinates = {};
        var colorButtons = {};
        var vehicle = {
            "id": null,
            "state": null,
            "routeCommitId": null,
            "seats": 0,
            "class": {
                "name": null
            },
            "location": {
                "lat": 0,
                "lng": 0,
                "bearing": 0
            },
            "distance": 0
        };

        function clearSelection() {
            if (selectedShape) {
                if (typeof selectedShape.setEditable == 'function') {
                    selectedShape.setEditable(false);
                }
                selectedShape = null;
            }
            curseldiv.innerHTML = "<b>No Selected Area</b>:";
        }

        function updateCurSelText(shape) {
            posstr = "" + selectedShape.position;
            if (typeof selectedShape.position == 'object') {
                posstr = selectedShape.position.toUrlValue();
            }
            pathstr = "" + selectedShape.getPath;
            if (typeof selectedShape.getPath == 'function') {
                pathstr = "[ ";
                for (var i = 0; i < selectedShape.getPath().getLength(); i++) {
                    // .toUrlValue(5) limits number of decimals, default is 6 but can do more
                    pathstr += selectedShape.getPath().getAt(i).toUrlValue(10) + " , ";
                    coordinates[i] = selectedShape.getPath().getAt(i).toUrlValue(10)

                }
                pathstr += "]";
                pathstr = pathstr.replace(' , ]', ']')
                return_locations_in_polygon(pathstr)
            }
            curseldiv.innerHTML = "<b>Selected Area</b>: " + selectedShape.type + " ; <i>Path Coordinates</i>: " + pathstr + " ";
        }

        function return_locations_in_polygon(pathstr){
            pathstr = pathstr.replace('[ ', '');
            pathstr = pathstr.replace(']', '');
            var dataToSend = {"coordinates": pathstr};
            var dataJSONed = JSON.stringify(dataToSend);
            $.ajax({
                url: '/api/return_locations_in_polygon',
                data: dataJSONed,
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                type: 'POST',
                success: function (data) {
                    for (let prop in data) {
                        vehicle['id'] = data[prop]['id'];
                        vehicle['state'] = data[prop]['state'];
                        vehicle['routeCommitId'] = data[prop]['routeCommitId'];
                        vehicle['seats'] = data[prop]['seats'];
                        vehicle['class']['name'] = data[prop]['class']['name'];
                        vehicle['location']['lat'] = data[prop]['location']['lat'];
                        vehicle['location']['lng'] = data[prop]['location']['lng'];
                        vehicle['location']['bearing'] = data[prop]['location']['bearing'];
                        vehicle['distance'] = data[prop]['distance'];
                        add_locations_to_map(vehicle);
                    }
                }, error: function (errormessage) {
                    console.log("Printing error message from vehicles in Polygon function: " + errormessage)
                }
            })
        }

        function get_all_locations(vehicle) {
            clearOverlays();
            clearSelection();
            if (shape != null) {shape.setMap(null);}
            $.ajax({
                url: '/api/return_all_locations',
                data: JSON.stringify({"status": "Show all vehicle locations"}),
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                cache: false,
                type: 'POST',
                success: function (data) {
                    let i = 0;
                    for (let prop in data) {
                        vehicle['id'] = data[prop]['id'];
                        vehicle['state'] = data[prop]['state'];
                        vehicle['routeCommitId'] = data[prop]['routeCommitId'];
                        vehicle['seats'] = data[prop]['seats'];
                        vehicle['class']['name'] = data[prop]['class']['name'];
                        vehicle['location']['lat'] = data[prop]['location']['lat'];
                        vehicle['location']['lng'] = data[prop]['location']['lng'];
                        vehicle['location']['bearing'] = data[prop]['location']['bearing'];
                        vehicle['distance'] = data[prop]['distance'];
                        i += 1;
                        add_locations_to_map(vehicle);
                        console.log("The locations arrived here in all locations: " + vehicle)

                    }
                }, error: function (errormessage) {
                    console.log("Printing error message: " + errormessage)
                }
            })
        }

        function add_locations_to_map(vehicle) {
            var latlng = {lat: vehicle['location']['lat'], lng: vehicle['location']['lng']}
            var marker = new google.maps.Marker({
                draggable: true,
                position: latlng,
                map: map,
                title: "Vehicle ID: " + vehicle['id'],
            });
            contentString = "Vehicle ID: " + vehicle['id'] + "<br>" + "State: " + vehicle['state'] + "<br>" +
                "routeCommitId: " + vehicle['routeCommitId'] + "<br>" + "Number of steats: " + vehicle['seats'] + "<br>" +
                "Class - name: " + vehicle['class']['name'] + "<br>" + "Location - (lat,lng,bearing): (" +
                vehicle['location']['lat'] + ", " + vehicle['location']['lng'] + ", " + vehicle['location']['bearing']
                + ")" + "<br>" + "Distance: " + vehicle['distance'];
            var infowindow = new google.maps.InfoWindow({
                content: contentString
            });
            marker.addListener('click', function () {
                infowindow.open(map, marker);
            });
            markersArray.push(marker);
            setBounds()
        }

        function drop() {
            for (var i = 0; i < markerArray.length; i++) {
                setTimeout(function () {
                    addMarkerMethod();
                }, i * 200);
            }
        }

        function setSelection(shape, isNotMarker) {
            clearSelection();
            selectedShape = shape;
            if (isNotMarker)
                shape.setEditable(true);
            selectColor(shape.get('fillColor') || shape.get('strokeColor'));
            updateCurSelText(shape);
        }

        function deleteSelectedShape() {
            clearOverlays();
            if (selectedShape) {
                selectedShape.setMap(null);
                drawingManager.setOptions({
                    drawingControl: true
                });
            }
        }

        function clearOverlays() {
            if (markersArray) {
                for (var i in markersArray) {
                    markersArray[i].setMap(null);
                }
            }
        }

        function selectColor(color) {
            selectedColor = color;
            for (var i = 0; i < colors.length; ++i) {
                var currColor = colors[i];
                colorButtons[currColor].style.border = currColor === color ? '2px solid #789' : '2px solid #fff';
            }
            // Retrieves the current options from the drawing manager and replaces the
            // stroke or fill color as appropriate.

            var polygonOptions = drawingManager.get('polygonOptions');
            polygonOptions.strokeColor = color;
            polygonOptions.fillColor = color;
            drawingManager.set('polygonOptions', polygonOptions);
        }

        function makeColorButton(color) {
            var button = document.createElement('span');
            button.className = 'color-button';
            button.style.backgroundColor = color;
            google.maps.event.addDomListener(button, 'click', function () {
                selectColor(color);
                setSelectedShapeColor(color);
            });
            return button;
        }

        function buildColorPalette() {
            var colorPalette = document.getElementById('color-palette');
            for (var i = 0; i < colors.length; ++i) {
                var currColor = colors[i];
                var colorButton = makeColorButton(currColor);
                colorPalette.appendChild(colorButton);
                colorButtons[currColor] = colorButton;
            }
            selectColor(colors[0]);
        }

        function setBounds() {
            bounds = new google.maps.LatLngBounds();
            for (var i = 0; i < markersArray.length; i++) {
                bounds.extend(markersArray[i].getPosition());
            }
            map.fitBounds(bounds, 5);
        }
        /////////////////////////////////////
        var map; //= new google.maps.Map(document.getElementById('map'), {
        // these must have global refs too!:
        var shape = null;
        var markersArray = [];
        var curposdiv;
        var curseldiv;
        var bounds;

        /////////////////////////////////////
        function initialize(listener) {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 12,//10,
                center: new google.maps.LatLng(51.510357, -0.116773),//Coordinates of Big Ben in London
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                disableDefaultUI: false,
                zoomControl: true
            });

            curposdiv = document.getElementById('curpos');
            curseldiv = document.getElementById('cursel');

            var polyOptions = {
                strokeWeight: 3,
                fillOpacity: 0.45,
                editable: true
            };
            // Creates a drawing manager attached to the map that allows the user to add
            // markers and draw polygons nad polylines
            drawingManager = new google.maps.drawing.DrawingManager({
                drawingMode: google.maps.drawing.OverlayType.POLYGON,
                drawingControlOptions: {
                    position: google.maps.ControlPosition.TOP_CENTER,
                    drawingModes: ['marker', 'polygon']
                },
                markerOptions: {
                    draggable: true,
                    editable: true,
                },
                polygonOptions: polyOptions,
                map: map
            });

            google.maps.event.addListener(drawingManager, 'overlaycomplete', function (event) {
                //~ if (e.type != google.maps.drawing.OverlayType.MARKER) {
                var isNotMarker = (event.type !== google.maps.drawing.OverlayType.POLYGON);

                // Once a secondary shape is drawn, the previous shape is deleted, and all of the vehicle locations
                // inside that shape are cleared.
                if (markersArray != null){clearOverlays();}
                if (shape != null) {shape.setMap(null);}
                // Switch back to non-drawing mode after drawing a shape.
                drawingManager.setDrawingMode(null);

                // Add an event listener that selects the newly-drawn shape when the user mouses down on it.
                shape = event.overlay;
                shape.type = event.type;

                google.maps.event.addListener(shape, 'click', function () {
                    setSelection(shape, isNotMarker);
                });
                google.maps.event.addListener(shape, 'drag', function () {
                    updateCurSelText(shape);
                });
                google.maps.event.addListener(shape, 'dragend', function () {
                    updateCurSelText(shape);
                });
                setSelection(shape, isNotMarker);
                //~ }// end if
            });

            // Clears the current selection when the drawing mode is changed
            google.maps.event.addListener(drawingManager, 'drawingmode_changed', clearSelection);

            // Clears the current selection when the map is clicked
            google.maps.event.addListener(map, 'click', clearSelection);

            // Deletes the current selected shape when the Delete button is clicked
            google.maps.event.addDomListener(document.getElementById('delete-button'), 'click', deleteSelectedShape);

            // Sends a HTTP POST request to retrieve all vehicle data and locations when the Show all vehicles data is clicked
            document.getElementById("show-all-vehicles").addEventListener("click", function(){get_all_locations(vehicle)});

            buildColorPalette();

        }

        google.maps.event.addDomListener(window, 'load', initialize);
    </script>
</head>
<body>
<div id="panel">
    <div id="color-palette"></div>
    <div>
        <button id="delete-button">Delete Selected Shape</button>
    </div>
    <div>
        <div>
            <button id="show-all-vehicles" type="submit">Show all vehicles</button>
        </div>
    </div>
    <div id="curpos"></div>
    <div id="cursel"></div>
    <div id="note"><small>Note: markers can be selected, but are not graphically indicated; can be deleted, but cannot
        have their color changed.</small></div>
</div>
<!-- TODO: Implement search box across top bar of the site-->
    <input id="pac-input" type="text" placeholder="Search Box">
<div id="map">A</div>
</body>
</html>
